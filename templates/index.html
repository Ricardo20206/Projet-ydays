{% extends "base.html" %}

{% block content %}
<style>
    .video-container {
        background: #111;
        color: white;
        font-family: Arial;
        padding: 40px;
    }

    video, img {
        width: 2400px;
        max-width: 90%;
        max-height: 600px;
        display: block;
        margin: 0 auto 10px auto;
        object-fit: contain;
    }

    button {
        padding: 10px 16px;
        cursor: pointer;
        background: crimson;
        border: none;
        color: white;
        border-radius: 5px;
    }

    input[type="file"] {
        margin-bottom: 20px;
    }
</style>

<div class="video-container">
    <h2>üìπ Charger une vid√©o ou une image</h2>

    <form action="/upload" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" accept="video/*,image/*" required>
        <br>
        <button type="submit">Afficher le m√©dia</button>
    </form>

    {% if video %}
        <hr>

        <video controls autoplay>
            <source src="{{ url_for('serve_video', filename=video) }}">
        </video>

        <div style="margin-top: 20px; text-align: center;">
            <button onclick="deleteFile('{{ video }}')">üóë Supprimer la vid√©o</button>
        </div>

        <hr style="margin: 30px 0;">

        <h3>üì§ Envoyer la vid√©o √† l'API de traitement</h3>
        <form id="sendToApiForm">
            <input type="hidden" name="video_filename" value="{{ video }}">
            <button type="submit" style="background: #4CAF50; margin-top: 10px;">
                üöÄ Envoyer √† l'API
            </button>
        </form>
        <div id="apiStatus" style="margin-top: 15px;"></div>
        
        {% if processed_video %}
        <div style="margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 5px;">
            <h4>‚úÖ Vid√©o trait√©e disponible :</h4>
            <video controls style="width: 2400px; max-width: 90%; max-height: 600px; display: block; margin: 10px auto;">
                <source src="{{ url_for('serve_video', filename=processed_video) }}">
            </video>
            <br>
            <div style="text-align: center; margin-top: 10px;">
                <a href="{{ url_for('serve_video', filename=processed_video) }}" download style="color: #4CAF50; text-decoration: none; display: inline-block;">
                    üì• T√©l√©charger la vid√©o trait√©e
                </a>
            </div>
        </div>
        {% endif %}
    {% elif image %}
        <hr>

        <img src="{{ url_for('serve_image', filename=image) }}" alt="Image upload√©e">

        <div style="margin-top: 20px; text-align: center;">
            <button onclick="deleteFile('{{ image }}')">üóë Supprimer l'image</button>
        </div>

        <hr style="margin: 30px 0;">

        <h3>üì§ Envoyer l'image √† l'API de traitement</h3>
        <form id="sendToApiForm">
            <input type="hidden" name="image_filename" value="{{ image }}">
            <button type="submit" style="background: #4CAF50; margin-top: 10px;">
                üöÄ Envoyer √† l'API
            </button>
        </form>
        <div id="apiStatus" style="margin-top: 15px;"></div>
        
        {% if processed_image %}
        <div style="margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 5px;">
            <h4>‚úÖ Image trait√©e disponible :</h4>
            <img src="{{ url_for('serve_image', filename=processed_image) }}" alt="Image trait√©e" style="width: 2400px; max-width: 90%; max-height: 600px; display: block; margin: 10px auto; object-fit: contain;">
            <br>
            <div style="text-align: center; margin-top: 10px;">
                <a href="{{ url_for('serve_image', filename=processed_image) }}" download style="color: #4CAF50; text-decoration: none; display: inline-block;">
                    üì• T√©l√©charger l'image trait√©e
                </a>
            </div>
        </div>
        {% endif %}
    {% endif %}
</div>

<script>
function deleteFile(filename) {
    fetch("/delete/" + filename, {
        method: "POST"
    })
    .then(() => {
        location.reload(); // page redevient vide
    });
}

// Gestion du formulaire d'envoi √† l'API
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('sendToApiForm');
    const statusDiv = document.getElementById('apiStatus');
    
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // V√©rifier si c'est une vid√©o ou une image
            const videoInput = form.querySelector('input[name="video_filename"]');
            const imageInput = form.querySelector('input[name="image_filename"]');
            const filename = videoInput ? videoInput.value : (imageInput ? imageInput.value : null);
            const isVideo = !!videoInput;
            
            if (!filename) {
                statusDiv.innerHTML = '<p style="color: #f44336;">‚ùå Erreur : Fichier non trouv√©</p>';
                return;
            }
            
            // Afficher le statut de chargement
            statusDiv.innerHTML = '<p style="color: #ffa500;">‚è≥ Envoi en cours...</p>';
            
            try {
                // Envoyer √† l'API via la route proxy
                const response = await fetch(`/send-to-api/${filename}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const mediaType = isVideo ? 'vid√©o' : 'image';
                    statusDiv.innerHTML = `<p style="color: #4CAF50;">‚úÖ ${mediaType.charAt(0).toUpperCase() + mediaType.slice(1)} envoy√©e et trait√©e avec succ√®s !</p>`;
                    // Recharger la page pour afficher le m√©dia trait√©
                    setTimeout(() => {
                        if (isVideo) {
                            window.location.href = `/?video=${filename}&processed=${data.processed_video}`;
                        } else {
                            window.location.href = `/?image=${filename}&processed_image=${data.processed_image}`;
                        }
                    }, 1500);
                } else {
                    statusDiv.innerHTML = `<p style="color: #f44336;">‚ùå Erreur : ${data.error || 'Erreur lors du traitement'}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #f44336;">‚ùå Erreur de connexion. Assurez-vous que l'API externe est d√©marr√©e (port 5001).</p>`;
                console.error('Erreur:', error);
            }
        });
    }
});
</script>
{% endblock %}
