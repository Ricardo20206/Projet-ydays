{% extends "base.html" %}

{% set hide_search = True %}

{% block content %}
<script>
    window.currentMedia = {
        video: null,
        image: null
    };
</script>
<div class="page-content">
    <h1 style="color: #2a2a2a; margin-bottom: 30px;">üîç Recherche</h1>
    
    <div class="search-bar" style="max-width: 100%; margin-bottom: 30px;">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" placeholder="Comment puis-je vous aider ?" id="searchInput" value="{{ query }}">
        <button type="button" id="sendToApiBtnSearch" class="send-btn" style="padding: 8px 16px; font-size: 14px; display: none;">
            <span class="btn-gold-text">GOLD</span>
        </button>
        <svg class="mic-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
        <svg class="sound-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
    </div>
    <div id="apiStatusSearch" style="text-align: center; margin-top: 10px;"></div>
    
    {% if query %}
    <div class="info-section">
        <h2>R√©sultats de recherche pour : "{{ query }}"</h2>
        <div id="searchResults">
            <p>‚è≥ Traitement de votre requ√™te par l'API...</p>
        </div>
    </div>
    {% else %}
    <div class="info-section">
        <h2>Rechercher vos m√©dias</h2>
        <p>Utilisez la barre de recherche ci-dessus pour trouver vos vid√©os et images.</p>
        <p>Tapez votre requ√™te et appuyez sur Entr√©e pour lancer la recherche.</p>
        <p style="margin-top: 15px; color: #666; font-size: 14px;">
            <strong>Note :</strong> Votre requ√™te sera automatiquement transmise √† l'API externe pour traitement.
        </p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const sendToApiBtnSearch = document.getElementById('sendToApiBtnSearch');
    const apiStatusSearch = document.getElementById('apiStatusSearch');
    
    // Afficher le bouton GOLD si un m√©dia est pr√©sent
    if (sendToApiBtnSearch && window.currentMedia) {
        if (window.currentMedia.video || window.currentMedia.image) {
            sendToApiBtnSearch.style.display = 'block';
        }
    }
    
    // Gestion du bouton "Envoyer √† l'API" sur la page de recherche
    if (sendToApiBtnSearch) {
        sendToApiBtnSearch.addEventListener('click', async function() {
            const currentMedia = window.currentMedia;
            let filename = null;
            let isVideo = false;
            
            if (currentMedia && currentMedia.video) {
                filename = currentMedia.video;
                isVideo = true;
            } else if (currentMedia && currentMedia.image) {
                filename = currentMedia.image;
                isVideo = false;
            }
            
            if (!filename) {
                alert('Aucun m√©dia √† envoyer. Veuillez d\'abord charger une vid√©o ou une image.');
                return;
            }
            
            if (apiStatusSearch) {
                apiStatusSearch.innerHTML = '<div class="status-message status-loading">‚è≥ Envoi en cours...</div>';
            }
            sendToApiBtnSearch.disabled = true;
            sendToApiBtnSearch.style.opacity = '0.6';
            
            try {
                const response = await fetch(`/send-to-api/${filename}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    if (apiStatusSearch) {
                        const mediaType = isVideo ? 'vid√©o' : 'image';
                        apiStatusSearch.innerHTML = `<div class="status-message status-success">‚úÖ ${mediaType.charAt(0).toUpperCase() + mediaType.slice(1)} envoy√©e et trait√©e avec succ√®s !</div>`;
                    }
                    
                    setTimeout(() => {
                        const currentPath = window.location.pathname;
                        if (isVideo) {
                            if (currentPath === '/video') {
                                window.location.href = `/video?video=${filename}&processed=${data.processed_video}`;
                            } else {
                                window.location.href = `/?video=${filename}&processed=${data.processed_video}`;
                            }
                        } else {
                            if (currentPath === '/image') {
                                window.location.href = `/image?image=${filename}&processed_image=${data.processed_image}`;
                            } else {
                                window.location.href = `/?image=${filename}&processed_image=${data.processed_image}`;
                            }
                        }
                    }, 1500);
                } else {
                    if (apiStatusSearch) {
                        apiStatusSearch.innerHTML = `<div class="status-message status-error">‚ùå Erreur : ${data.error || 'Erreur lors du traitement'}</div>`;
                    }
                    sendToApiBtnSearch.disabled = false;
                    sendToApiBtnSearch.style.opacity = '1';
                }
            } catch (error) {
                if (apiStatusSearch) {
                    apiStatusSearch.innerHTML = '<div class="status-message status-error">‚ùå Erreur de connexion. Assurez-vous que l\'API externe est d√©marr√©e (port 5001).</div>';
                }
                sendToApiBtnSearch.disabled = false;
                sendToApiBtnSearch.style.opacity = '1';
                console.error('Erreur:', error);
            }
        });
    }
    
    // Si une requ√™te est pr√©sente dans l'URL, afficher les r√©sultats
    {% if query %}
    fetch('/send-query-to-api', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: "{{ query }}" })
    })
    .then(response => response.json())
    .then(data => {
        if (searchResults) {
            if (data.status === 'success') {
                searchResults.innerHTML = `
                    <div class="status-message status-success" style="margin-bottom: 20px;">
                        ‚úÖ ${data.response || 'Requ√™te trait√©e avec succ√®s'}
                    </div>
                    <p><strong>Requ√™te :</strong> "${data.query}"</p>
                    <p><strong>Timestamp :</strong> ${data.timestamp || 'N/A'}</p>
                    <p style="margin-top: 20px;">Fonctionnalit√© de recherche avanc√©e en cours de d√©veloppement...</p>
                `;
            } else {
                searchResults.innerHTML = `
                    <div class="status-message status-error">
                        ‚ùå Erreur : ${data.error || 'Erreur lors du traitement'}
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        if (searchResults) {
            searchResults.innerHTML = `
                <div class="status-message status-error">
                    ‚ùå Erreur de connexion √† l'API externe
                </div>
            `;
        }
        console.error('Erreur:', error);
    });
    {% endif %}
    
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    window.location.href = `/search?q=${encodeURIComponent(query)}`;
                }
            }
        });
    }
});
</script>
{% endblock %}
